From 8d1a42ca1e3fa818bf0f8672403c157dbbdf8cc1 Mon Sep 17 00:00:00 2001
From: Matthias Leitl <a.dead.trousers@gmail.com>
Date: Fri, 22 Mar 2024 21:55:43 +0100
Subject: [PATCH 1/1] Add missing symbol for mediatek vtservice

Change-Id: I3ee83082e5cfdb6ef833ce5b7311f96bf00dbf9f
---
 media/libaudioclient/AudioTrack.cpp | 33 +++++++++++++++++++++++++++++
 1 file changed, 33 insertions(+)

diff --git a/media/libaudioclient/AudioTrack.cpp b/media/libaudioclient/AudioTrack.cpp
index 54d186e3b3..e89429930f 100644
--- a/media/libaudioclient/AudioTrack.cpp
+++ b/media/libaudioclient/AudioTrack.cpp
@@ -3784,3 +3784,36 @@ void AudioTrack::AudioTrackCallback::setAudioTrackCallback(
 }
 
 } // namespace android
+
+extern "C" {
+// Old constructor without attributionSource
+void _ZN7android10AudioTrackC1E19audio_stream_type_tj14audio_format_tjj20audio_output_flags_tPFviPvS4_ES4_i15audio_session_tNS0_13transfer_typeEPK20audio_offload_info_tjiPK18audio_attributes_tbfi(
+        void* thisptr,
+        audio_stream_type_t streamType,
+        uint32_t sampleRate,
+        audio_format_t format,
+        audio_channel_mask_t channelMask,
+        size_t frameCount,
+        audio_output_flags_t flags,
+        android::AudioTrack::callback_t cbf,
+        void* user,
+        int32_t notificationFrames,
+        audio_session_t sessionId,
+        android::AudioTrack::transfer_type transferType,
+        const audio_offload_info_t *offloadInfo,
+        uid_t uid,
+        pid_t pid,
+        const audio_attributes_t* pAttributes,
+        bool doNotReconnect,
+        float maxRequiredSpeed,
+        audio_port_handle_t selectedDeviceId) {
+                AttributionSourceState attributionSource;
+                attributionSource.uid = VALUE_OR_FATAL(android::legacy2aidl_uid_t_int32_t(uid));
+                attributionSource.pid = VALUE_OR_FATAL(android::legacy2aidl_uid_t_int32_t(pid));
+                attributionSource.packageName = "com.mediatek.ims";
+                
+                thisptr = new android::AudioTrack(streamType, sampleRate, format, channelMask, frameCount, flags, cbf,
+                        user, notificationFrames, sessionId, transferType, offloadInfo, attributionSource,
+                        pAttributes, doNotReconnect, maxRequiredSpeed, selectedDeviceId);
+        }
+}
-- 
2.34.1

