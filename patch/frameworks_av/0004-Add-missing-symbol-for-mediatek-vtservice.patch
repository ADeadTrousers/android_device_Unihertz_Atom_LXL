From c335eee4382b6680040a15713c146f40ab0c42f5 Mon Sep 17 00:00:00 2001
From: Matthias Leitl <a.dead.trousers@gmail.com>
Date: Sun, 7 Apr 2024 20:27:39 +0200
Subject: [PATCH 1/1] Add missing symbol for mediatek vtservice

Change-Id: If021a9821e6c57d588761f7837834aeb9ef6eee7
---
 media/libaudioclient/AudioTrack.cpp | 33 +++++++++++++++++++++++++++++
 1 file changed, 33 insertions(+)

diff --git a/media/libaudioclient/AudioTrack.cpp b/media/libaudioclient/AudioTrack.cpp
index 54d186e3b3..f97d60bbf0 100644
--- a/media/libaudioclient/AudioTrack.cpp
+++ b/media/libaudioclient/AudioTrack.cpp
@@ -3784,3 +3784,36 @@ void AudioTrack::AudioTrackCallback::setAudioTrackCallback(
 }
 
 } // namespace android
+
+extern "C" {
+// Old constructor without attributionSource
+void _ZN7android10AudioTrackC1E19audio_stream_type_tj14audio_format_tjj20audio_output_flags_tPFviPvS4_ES4_i15audio_session_tNS0_13transfer_typeEPK20audio_offload_info_tjiPK18audio_attributes_tbfi(
+        void* thisptr,
+        audio_stream_type_t streamType,
+        uint32_t sampleRate,
+        audio_format_t format,
+        audio_channel_mask_t channelMask,
+        size_t frameCount,
+        audio_output_flags_t flags,
+        android::AudioTrack::callback_t cbf,
+        void* user,
+        int32_t notificationFrames,
+        audio_session_t sessionId,
+        android::AudioTrack::transfer_type transferType,
+        const audio_offload_info_t *offloadInfo,
+        uid_t uid,
+        pid_t pid,
+        const audio_attributes_t* pAttributes,
+        bool doNotReconnect,
+        float maxRequiredSpeed,
+        audio_port_handle_t selectedDeviceId) {
+                AttributionSourceState attributionSource;
+                attributionSource.uid = VALUE_OR_FATAL(android::legacy2aidl_uid_t_int32_t(uid));
+                attributionSource.pid = VALUE_OR_FATAL(android::legacy2aidl_uid_t_int32_t(pid));
+                attributionSource.packageName = "com.mediatek.ims";
+                
+                new (thisptr) android::AudioTrack(streamType, sampleRate, format, channelMask, frameCount, flags, cbf,
+                        user, notificationFrames, sessionId, transferType, offloadInfo, attributionSource,
+                        pAttributes, doNotReconnect, maxRequiredSpeed, selectedDeviceId);
+        }
+}
-- 
2.34.1

